<!DOCTYPE html>
<html>
  <head>
    <link
      rel="shortcut icon"
      type="image/png"
      href="{{ url_for('static', filename='../images/favicon.png') }}"
    />

    <link
      rel="stylesheet"
      type="text/css"
      href="{{ url_for('static', filename='../css/controller.css') }}"
    />

    <title>jlock control</title>
  </head>

  <body>
    <header>
      <h1>jlock</h1>
      <span class="identifier">on <em>{{host_name }}</em></span>
    </header>

    <main>
      <section id="styles">
        <h2>Styles</h2>

        <ul>
          {% for style in styles %} {% set name = style.split('.')[0] %}
          <li>
            <button id="style-{{name}}" onClick="select('style', '{{name}}')">
              {{name | replace("-", " ")}}
            </button>
          </li>
          {% endfor %}
        </ul>
      </section>

      <section id="languages">
        <h2>Languages</h2>

        <ul>
          {% for id, name in languages.items() %}
          <li>
            <button id="language-{{id}}" onClick="select('language', '{{id}}')">
              {{name}}
            </button>
          </li>
          {% endfor %}
        </ul>
      </section>
    </main>

    <script>
      let currents = {
        style: null,
        languages: null,
      };

      let select = function (selectable, id) {
        if (currents[selectable] == id) {
          return;
        }

        let buttons = document.querySelectorAll(`#${selectable}s button`);
        buttons.forEach(function (b) {
          ["selected", "pending"].forEach(function (state) {
            b.classList.remove(state);
          });
        });

        setButtonClass(`#${selectable}s`, `#${selectable}-${id}`, "pending");

        sendData(`/controller/${selectable}`, id).then(function (data) {
          setActive(selectable);
        });
      };

      let sendData = function (endPoint, value) {
        return fetch(endPoint, {
          headers: { "Content-Type": "application/json" },
          method: "POST",
          body: JSON.stringify({ value: value }),
        });
      };

      let setActive = function (selectable) {
        fetch(`/controller/${selectable}`, {
          headers: { "Content-Type": "application/json" },
          method: "GET",
        })
          .then(function (response) {
            return response.json();
          })
          .then(function (json) {
            setButtonClass(
              `#${selectable}s`,
              `#${selectable}-${json[selectable]}`,
              "selected"
            );
            console.log(`${selectable}: ${json[selectable]}`);
            currents[selectable] = json[selectable];
          });
      };

      let setButtonClass = function (enclosing, id, klass) {
        let button = document.querySelector(`${enclosing} ${id}`);
        button.classList.add(klass);
      };

      ["style", "language"].forEach(function (item) {
        setActive(item);
      });
    </script>
  </body>
</html>
